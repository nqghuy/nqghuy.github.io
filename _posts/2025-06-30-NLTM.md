---
title: "NTLM - Network Authentication Analysis"
date: 2025-07-04 12:00:00 +0700
categories: [CTF, Network Forensics]
tags: [ntlm, wireshark, hashcat, authentication, windows]
image:
  path: /assets/img/posts/NLTM/banner.png
  alt: NTLM Authentication
---

## Gi·ªõi thi·ªáu
## Statement
You have been commissioned by the Cat Corporation SOC team to recover the password of a user linked to a suspicious NTLM over SMB connection.
**Difficulty**: Medium  
**Category**: Network  
**Tools**: Wireshark, hashcat

B√†i lab ph√¢n t√≠ch giao th·ª©c NTLM authentication v√† crack password hash.

## Ph√¢n t√≠ch NTLM Authentication Flow

Filter `ntlmssp` trong Wireshark

ƒê·∫ßu ti√™n client s·∫Ω request session, `NTLMSSP_NEGOTIATE`

Ti·∫øp ƒë·∫øn, server tr·∫£ v·ªÅ `NTLMSSP_CHALLENGE`

![image.png](/assets/img/posts/NLTM/image%201.png)

ƒê∆°n gi·∫£n l√† g·ª≠i 1 chu·ªói random

NTLMv2_Response = HMAC_MD5(NTLMv2_Hash, ServerChallenge + Blob)

- `NTLMv2_Hash = HMAC_MD5(NT_Hash, username + domain)`
- `NT_Hash = MD4(UTF-16LE(password))`
- `Blob` ch·ª©a nhi·ªÅu th·ª©: timestamp, client challenge, target info, flags...

## NTProofStr (NT Proof String)

- ƒê√¢y l√† **16-byte ƒë·∫ßu ti√™n** c·ªßa `NTLMv2_Response`.
- Th·∫≠t ra, n√≥ **ch√≠nh l√†** `HMAC_MD5(NTLMv2_Hash, ServerChallenge + Blob)`

üìå **M·ª•c ƒë√≠ch**: Server s·∫Ω t·ª± t·∫°o l·∫°i chu·ªói n√†y t·ª´ th√¥ng tin n√≥ c√≥, n·∫øu gi·ªëng v·ªõi client g·ª≠i ‚Üí x√°c th·ª±c th√†nh c√¥ng

### C·∫•u tr√∫c NTLMv2 Response:

```
NTLMv2 Response =
    NTProofStr (16 bytes HMAC) +
    Blob (timestamp, client challenge, target info...)
```

### Server c√≥ nh·ªØng g√¨?

- Challenge m√† n√≥ ƒë√£ g·ª≠i
- Username, domain
- V√† **m·∫≠t kh·∫©u ƒë√£ l∆∞u d·∫°ng NT hash**
- NTLMv2 Hash: `HMAC_MD5(NT_Hash, Username + Domain)`
- V√† **client g·ª≠i l·∫°i Blob + NTProofStr**

### C√°ch server x√°c minh:

1. **D√πng NTLMv2 Hash**
2. Gh√©p: `ServerChallenge + Blob`
3. T√≠nh:
    
    ```python
    HMAC_MD5(NTLMv2_Hash, ServerChallenge + Blob)
    ```
    
4. So s√°nh v·ªõi c√°i client g·ª≠i (NTProofStr)

üëâ **N·∫øu tr√πng ‚Üí x√°c th·ª±c th√†nh c√¥ng.**

## Crack password v·ªõi hashcat

[https://www.youtube.com/watch?v=lhhlgoMjM7o&pp=0gcJCfwAo7VqN5tD](https://www.youtube.com/watch?v=lhhlgoMjM7o&pp=0gcJCfwAo7VqN5tD)

```bash
‚îî‚îÄ$ hashcat -hh | grep "ntlm" -i
   5500 | NetNTLMv1 / NetNTLMv1+ESS                                  | Network Protocol
  27000 | NetNTLMv1 / NetNTLMv1+ESS (NT)                             | Network Protocol
   5600 | NetNTLMv2                                                  | Network Protocol
  27100 | NetNTLMv2 (NT)                                             | Network Protocol
   1000 | NTLM                                                       | Operating System
```

S·ª≠ d·ª•ng mode 5600 cho NetNTLMv2

```bash
‚îå‚îÄ‚îÄ(nqghuy„âøDESKTOP-AJTP5JK)-[~/forensics/ch28]
‚îî‚îÄ$ hashcat --example-hashes | grep "Hash mode #5600" -A 20
Hash mode #5600
  Name................: NetNTLMv2
  Category............: Network Protocol
  Slow.Hash...........: No
  Deprecated..........: No
  Deprecated.Notice...: N/A
  Password.Type.......: plain
  Password.Len.Min....: 0
  Password.Len.Max....: 256
  Salt.Type...........: Embedded
  Salt.Len.Min........: 0
  Salt.Len.Max........: 256
  Kernel.Type(s)......: pure, optimized
  Example.Hash.Format.: plain
  Example.Hash........: 0UL5G37JOI0SX::6VB1IS0KA74:ebe1afa18b7fbfa6:aab8bf8675658dd2a939458a1077ba08:010100000000000031c8aa092510945398b9f7b7dde1a9fb00000000f7876f2b04b700
  Example.Pass........: hashcat
  Benchmark.Mask......: ?a?a?a?a?a?a?a
  Autodetect.Enabled..: Yes
  Self.Test.Enabled...: Yes
  Potfile.Enabled.....: Yes
  Keep.Guessing.......: No
```

C·ªông v·ªõi xem youtube, ta c√≥ file hashcat.txt

```bash
john.doe::catcorp.local:1944952f5b845db1:5c336c6b69fd2cf7b64eb0bde3102162:01010000000000001a9790044b63da0175304c546c6f34320000000002000e0043004100540043004f005200500001000800440043003000310004001a0063006100740063006f00720070002e006c006f00630061006c000300240044004300300031002e0063006100740063006f00720070002e006c006f00630061006c0005001a0063006100740063006f00720070002e006c006f00630061006c00070008001a9790044b63da010900120063006900660073002f0044004300300031000000000000000000
```

Crack hash:

```bash
‚îå‚îÄ‚îÄ(nqghuy„âøDESKTOP-AJTP5JK)-[~/forensics/ch28]
‚îî‚îÄ$ hashcat --show hashcat.txt
Hash-mode was not specified with -m. Attempting to auto-detect hash mode.
The following mode was auto-detected as the only one matching your input hash:

5600 | NetNTLMv2 | Network Protocol

NOTE: Auto-detect is best effort. The correct hash-mode is NOT guaranteed!
Do NOT report auto-detect issues unless you are certain of the hash type.

JOHN.DOE::catcorp.local:1944952f5b845db1:5c336c6b69fd2cf7b64eb0bde3102162:01010000000000001a9790044b63da0175304c546c6f34320000000002000e0043004100540043004f005200500001000800440043003000310004001a0063006100740063006f00720070002e006c006f00630061006c000300240044004300300031002e0063006100740063006f00720070002e006c006f00630061006c0005001a0063006100740063006f00720070002e006c006f00630061006c00070008001a9790044b63da010900120063006900660073002f0044004300300031000000000000000000:rootbeer
```

**Password**: `rootbeer`

## Tham kh·∫£o

-