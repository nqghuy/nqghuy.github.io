---
layout: post
title: "Evil PCAP - Network Forensics Challenge"
date: 2025-07-04
categories: [Network Forensics, CTF]
tags: [wireshark, tshark, PCAP Analysis, HTTP Traffic, Reverse Proxy]
difficulty: Hard
---

# Evil PCAP

**Difficulty:** Medium
**Category:** Network  
**Tools:** Wireshark, tshark

---
ÄÃ¢y lÃ  má»™t challenge ctf forensics tá»« idek ctf 2025.
## ğŸ” Initial Analysis

![HTTP Traffic Overview](../assets/img/posts/Evil_pcap/image.png)

PhÃ¢n tÃ­ch traffic ban Ä‘áº§u cho tháº¥y:
- User-Agent `my-python-requests-useragent` vá»›i `/instructions.png` â†’ tráº£ vá» **200 OK**
- User-Agent `curl` vá»›i `/password` â†’ **bá»‹ cháº·n**

---

## ğŸ”“ Bypassing User-Agent Restriction

### Extracting Password

```bash
â”Œâ”€â”€(nqghuyã‰¿DESKTOP-AJTP5JK)-[~]
â””â”€$ curl --help | grep -u 'user-agent'
grep: warning: --unix-byte-offsets (-u) is obsolete
 -A, --user-agent <name>     Send User-Agent <name> to server
```

Sá»­ dá»¥ng User-Agent chÃ­nh xÃ¡c Ä‘á»ƒ bypass:

```bash
â”Œâ”€â”€(nqghuyã‰¿DESKTOP-AJTP5JK)-[~]
â””â”€$ curl -A "my-python-requests-useragent" http://143.198.13.84:80/password.txt
verysecureidek2025themedpassword
```

âœ… **Password obtained:** `verysecureidek2025themedpassword`

---

## ğŸ“‹ Understanding Instructions

![Instructions Image](../assets/img/posts/Evil_pcap/instructions.png)

---

## ğŸŒ Proxy vs Reverse Proxy

### âœ… **Proxy (Forward Proxy)**

- LÃ  **mÃ¡y trung gian giá»¯a client (ngÆ°á»i dÃ¹ng)** vÃ  **server (mÃ¡y chá»§)**
- Client gá»­i request â†’ Proxy nháº­n vÃ  chuyá»ƒn tiáº¿p Ä‘áº¿n server â†’ Tráº£ káº¿t quáº£ vá» client

#### ğŸ“Œ Má»¥c Ä‘Ã­ch cá»§a Proxy:

- **áº¨n IP** tháº­t cá»§a client
- **Bypass firewall / cháº·n ná»™i dung**
- **Lá»c ná»™i dung**, giÃ¡m sÃ¡t truy cáº­p
- **TÄƒng tá»‘c truy cáº­p** (báº±ng cache)

---

### âœ… **Reverse Proxy**

- LÃ  **mÃ¡y trung gian Ä‘á»©ng phÃ­a trÆ°á»›c server**, Ä‘Ã³ng vai trÃ² nhÆ° **cá»­a ngÃµ**
- User gá»­i request â†’ Reverse Proxy nháº­n trÆ°á»›c â†’ Chuyá»ƒn Ä‘áº¿n backend server

#### ğŸ“Œ Má»¥c Ä‘Ã­ch cá»§a Reverse Proxy:

- **PhÃ¢n phá»‘i táº£i (load balancing)** giá»¯a nhiá»u server
- **áº¨n thÃ´ng tin backend server** (IP, cáº¥u trÃºc thá»±c táº¿)
- **Cache ná»™i dung**, giáº£m táº£i cho server
- **ThÃªm lá»›p báº£o máº­t** (lá»c request dá»±a trÃªn IP, User-Agent,...)
- **SSL termination** (mÃ£ hÃ³a HTTPS chá»‰ thá»±c hiá»‡n á»Ÿ proxy)

---

### ğŸ“Š So sÃ¡nh Proxy vs Reverse Proxy

| Thuá»™c tÃ­nh | Proxy (Forward) | Reverse Proxy |
|-----------|-----------------|---------------|
| **Äá»©ng giá»¯a** | Client vÃ  Server | Internet vÃ  Server ná»™i bá»™ |
| **áº¨n IP cá»§a** | Client | Server |
| **DÃ¹ng Ä‘á»ƒ** | TrÃ¡nh kiá»ƒm duyá»‡t, áº©n danh | Báº£o máº­t, cÃ¢n báº±ng táº£i, caching |
| **VÃ­ dá»¥ thá»±c táº¿** | Tor, VPN | Nginx, HAProxy, Cloudflare |

> **Note:** Reverse Proxy thÆ°á»ng Ä‘Æ°á»£c server dÃ¹ng Ä‘á»ƒ **kiá»ƒm soÃ¡t request**, vÃ­ dá»¥: chá»‰ cho phÃ©p má»™t sá»‘ User-Agent truy cáº­p tÃ i nguyÃªn, lá»c theo IP, header, cookie...

---

## ğŸ”¬ Analyzing Suspicious Requests with tshark

### Extracting HTTP Requests

```bash
â”Œâ”€â”€(nqghuyã‰¿DESKTOP-AJTP5JK)-[/mnt/e/CTF/misc/soc-intern-tasking/attachments]
â””â”€$ tshark -r evil.pcapng -Y 'http.user_agent contains "my-python-requests"' -Tfields -e http.request.uri
/instructions.png
/instructions.png
/%1F
/%01
/%17
/%12
/%08
/%11
/instructions.png
/%0B
/D
/%1C
/%0E
/X
/%0A
/%02
/4
/%5E
/%01
/Y
/%06
/%2B
/%09
/%3A
/%1F
/V
/%00
/%2F
/%15
/%40
/%12
/%1A
/%0A
/%00
/%19
```

#### ğŸ“š tshark Parameters:

- `-r <infile>`: Read from capture file
- `-Y <display filter>`: Apply display filter
- `-T fields`: Output format as fields
- `-e <field>`: Field to print (e.g., `http.request.uri`)

---

### Filtering and Cleaning Data

```bash
â”Œâ”€â”€(nqghuyã‰¿DESKTOP-AJTP5JK)-[/mnt/e/CTF/misc/soc-intern-tasking/attachments]
â””â”€$ tshark -r evil.pcapng -Y 'http.user_agent contains "my-python-requests"' \
    -Tfields -e http.request.uri | grep -v "instructions.png" | sed 's/[\/%]//g'
1F
01
17
12
08
11
0B
D
1C
0E
X
0A
02
4
5E
01
Y
06
2B
09
3A
1F
V
00
2F
15
40
12
1A
0A
00
19
```

#### ğŸ“š sed Command Breakdown:

| ThÃ nh pháº§n | Ã nghÄ©a |
|-----------|---------|
| `s/.../.../g` | Substitute (thay tháº¿) trong `sed` |
| `[\/%]` | Regex khá»›p vá»›i `/` hoáº·c `%` |
| `//` | Thay báº±ng chuá»—i rá»—ng â†’ **xÃ³a** cÃ¡c kÃ½ tá»± khá»›p |
| `g` | Global â€“ thay táº¥t cáº£ cÃ¡c kÃ½ tá»± khá»›p trÃªn má»—i dÃ²ng |

> **Note:** Náº¿u bá» `g`, chá»‰ xÃ³a 1 kÃ½ tá»± Ä‘áº§u tiÃªn trÃªn má»—i dÃ²ng.

---

### Combining All Values

```bash
â”Œâ”€â”€(nqghuyã‰¿DESKTOP-AJTP5JK)-[/mnt/e/CTF/misc/soc-intern-tasking/attachments]
â””â”€$ tshark -r evil.pcapng -Y 'http.user_agent contains "my-python-requests"' \
    -Tfields -e http.request.uri | grep -v "instructions.png" | sed 's/[\/%]//g' | tr -d '\n'
1F01171208110BD1C0EX0A0245E01Y062B093A1FV002F1540121A0A0019
```

**Command explanation:**
- `tr -d '\n'`: XÃ³a táº¥t cáº£ newline characters â†’ ghÃ©p thÃ nh 1 dÃ²ng

---

## ğŸ” Decoding the Payload

### Converting Non-Hex Characters

Chuyá»ƒn Ä‘á»•i cÃ¡c kÃ½ tá»± `D, X, 4, Y, V` sang hex:

![Character to Hex Conversion](../assets/img/posts/Evil_pcap/image%201.png)

| Character | ASCII Code | Hex |
|-----------|-----------|-----|
| D | 68 | 44 |
| X | 88 | 58 |
| 4 | 52 | 34 |
| Y | 89 | 59 |
| V | 86 | 56 |

### Final Hex String

```
1F01171208110B441C0E580A02345E0159062B093A1F56002F1540121A0A0019
```

![Final Decoded Output](../assets/img/posts/Evil_pcap/image%202.png)

---

## ğŸ“ Summary

Challenge nÃ y minh há»a:
- **Reverse Proxy filtering** dá»±a trÃªn User-Agent
- **Data exfiltration** thÃ´ng qua HTTP URIs
- **Hex encoding** Ä‘á»ƒ áº©n giáº¥u thÃ´ng tin
- Sá»­ dá»¥ng **tshark** Ä‘á»ƒ phÃ¢n tÃ­ch PCAP files
- **Command-line data processing** vá»›i sed, grep, tr

**Key Takeaways:**
- LuÃ´n kiá»ƒm tra User-Agent restrictions
- HTTP URIs cÃ³ thá»ƒ chá»©a dá»¯ liá»‡u áº©n
- Káº¿t há»£p nhiá»u cÃ´ng cá»¥ CLI Ä‘á»ƒ xá»­ lÃ½ data hiá»‡u quáº£