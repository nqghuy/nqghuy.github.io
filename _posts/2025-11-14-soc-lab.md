---
title: "XÃ¢y dá»±ng Web Server vÃ  SOC Homelab"
date: 2025-10-04 12:00:00 +0700
categories: [Homelab, Security]
tags: [server, wazuh, suricata, siem, ids, nginx, cloudflare]
image:
  path: /assets/img/posts/soc-lab/wazuh.png
  alt: Wazuh Dashboard
---

BÃ i viáº¿t chia sáº» quÃ¡ trÃ¬nh xÃ¢y dá»±ng má»™t web server vÃ  SOC homelab Ä‘Æ¡n giáº£n táº¡i nhÃ , bao gá»“m Wazuh (SIEM), Suricata (IDS), Sysmon vÃ  Shuffle (SOAR - sáº¯p triá»ƒn khai).

## Tá»•ng quan

Vá»›i má»™t chiáº¿c laptop cÅ© vÃ  1 PC khÃ´ng sá»­ dá»¥ng, mÃ¬nh quyáº¿t Ä‘á»‹nh táº­n dá»¥ng nÃ³ Ä‘á»ƒ xÃ¢y dá»±ng:
- **Web Server** vá»›i Nginx
- **Wazuh** - SIEM platform
- **Suricata** - IDS/IPS
- **Shuffle** - SOAR (coming soon)
---

## 1. XÃ¢y dá»±ng Web Server

### 1.1. Cáº¥u hÃ¬nh IP tÄ©nh

Ban Ä‘áº§u, mÃ¬nh Ä‘á»‹nh host web báº±ng cÃ¡ch má»Ÿ cá»•ng router. Cáº¥u hÃ¬nh trong `/etc/netplan/50-cloud-init.yaml`:

```yaml
network:
  version: 2
  wifis:
    wlp3s0:
      dhcp4: false
      addresses: [192.168.1.23/24]
      routes:
        - to: default
          via: 192.168.1.1
      nameservers:
        addresses: [1.1.1.1, 8.8.8.8]
      access-points:
        "HUY KHUONG":
          auth:
            key-management: "psk"
            password: "*******"
```

### 1.2. Cáº¥u hÃ¬nh Nginx

Káº¿t ná»‘i domain trong `/etc/nginx/sites-available/default`:

```nginx
server_name halcyonfold.com www.halcyonfold.com;
```

### 1.3. Sá»­ dá»¥ng Cloudflare Tunnel

> **Váº¥n Ä‘á» gáº·p pháº£i:** VNPT cháº·n cÃ¡c cá»•ng phá»• biáº¿n (80, 443) vÃ  IP Ä‘á»™ng thay Ä‘á»•i liÃªn tá»¥c.
{: .prompt-warning }

**Giáº£i phÃ¡p:** Sá»­ dá»¥ng Cloudflare Tunnel Ä‘á»ƒ bypass cÃ¡c háº¡n cháº¿ nÃ y.

#### Cáº¥u hÃ¬nh DNS

![Cloudflare DNS Settings](../assets/img/posts/soc-lab/domain.png)
_Chuyá»ƒn nameserver sang Cloudflare_

#### Táº¡o Tunnel

![Cloudflare Tunnel](../assets/img/posts/soc-lab/tunnel.png)
_Cáº¥u hÃ¬nh Cloudflare Tunnel_

Cháº¡y lá»‡nh theo hÆ°á»›ng dáº«n:

![Tunnel Command](../assets/img/posts/soc-lab/tunnel_command.png)

---

## 2. Triá»ƒn khai Wazuh

### 2.1. Giá»›i thiá»‡u

**Wazuh** lÃ  ná»n táº£ng báº£o máº­t mÃ£ nguá»“n má»Ÿ, káº¿t há»£p SIEM vÃ  XDR vá»›i 3 thÃ nh pháº§n chÃ­nh:

| ThÃ nh pháº§n | Chá»©c nÄƒng |
|------------|-----------|
| **Server** | PhÃ¢n tÃ­ch log, phÃ¡t hiá»‡n má»‘i Ä‘e dá»a, quáº£n lÃ½ agent |
| **Indexer** | LÆ°u trá»¯ vÃ  tÃ¬m kiáº¿m dá»¯ liá»‡u |
| **Dashboard** | Giao diá»‡n trá»±c quan, biá»ƒu Ä‘á»“ |

### 2.2. CÃ i Ä‘áº·t

#### Kiá»ƒm tra Docker

```bash
docker compose version
# Output: Docker Compose version v2.40.3
```

#### Clone repository

```bash
git clone https://github.com/wazuh/wazuh-docker.git -b v4.11.2
cd wazuh-docker/single-node
```

#### Generate certificates

```bash
docker-compose -f generate-indexer-certs.yml run --rm generator
```

#### Khá»Ÿi Ä‘á»™ng

```bash
docker-compose up -d
```

#### Verify containers

```bash
sudo docker ps
```

```
CONTAINER ID   IMAGE                          PORTS                                              NAMES
dbcc4cc839ba   wazuh/wazuh-dashboard:4.11.2   0.0.0.0:443->5601/tcp                             single-node-wazuh.dashboard-1
e780f5c87c27   wazuh/wazuh-indexer:4.11.2     0.0.0.0:9200->9200/tcp                            single-node-wazuh.indexer-1
3fcd3e4f73bf   wazuh/wazuh-manager:4.11.2     0.0.0.0:1514-1515->1514-1515/tcp, 55000/tcp       single-node-wazuh.manager-1
```

### 2.3. Truy cáº­p Dashboard

![Wazuh Dashboard](../assets/img/posts/soc-lab/wazuh.png)
_Wazuh Dashboard interface_

> **ThÃ´ng tin Ä‘Äƒng nháº­p:** `admin` / `SecretPassword`
{: .prompt-info }

### 2.4. ThÃªm Agent

![Add Agent](../assets/img/posts/soc-lab/agent.png)
_ThÃªm agent Ä‘áº§u tiÃªn (web server)_

#### Cáº¥u hÃ¬nh Nginx log

ThÃªm vÃ o `/var/ossec/etc/ossec.conf`:

![Nginx Log Configuration](../assets/img/posts/soc-lab/nginx-log.png)

### 2.5. Test SQL Injection

![SQL Injection Alert](../assets/img/posts/soc-lab/sql-injection.png)
_Wazuh phÃ¡t hiá»‡n SQL injection attack_

> Máº·c dÃ¹ traffic Ä‘i qua Cloudflare Tunnel, Nginx váº«n ghi log vÃ  Wazuh phÃ¢n tÃ­ch Ä‘á»ƒ Ä‘Æ°a ra cáº£nh bÃ¡o.
{: .prompt-tip }

---

## 3. Triá»ƒn khai Suricata

### 3.1. Giá»›i thiá»‡u

**Suricata** lÃ  IDS/IPS mÃ£ nguá»“n má»Ÿ vá»›i 2 cháº¿ Ä‘á»™:

| Cháº¿ Ä‘á»™ | MÃ´ táº£ | Loáº¡i |
|--------|-------|------|
| **AF_PACKET** | Káº¿t ná»‘i trá»±c tiáº¿p card máº¡ng, kernel copy traffic | IDS |
| **NFQUEUE** | Káº¿t há»£p iptables, cÃ³ thá»ƒ drop gÃ³i tin | IPS |

### 3.2. CÃ i Ä‘áº·t

```bash
sudo apt-get install software-properties-common
sudo add-apt-repository ppa:oisf/suricata-stable
sudo apt-get update
sudo apt-get install suricata
```

### 3.3. Cáº¥u hÃ¬nh

#### XÃ¡c Ä‘á»‹nh network interface

```bash
ip a
```

```
2: wlp3s0: <BROADCAST,MULTICAST,UP,LOWER_UP>
    inet 192.168.1.23/24 brd 192.168.1.255 scope global wlp3s0
```

#### Cáº¥u hÃ¬nh AF_PACKET

Sá»­a `/etc/suricata/suricata.yaml`:

```yaml
af-packet:
  - interface: wlp3s0
```

#### Cáº¥u hÃ¬nh HOME_NET

```yaml
HOME_NET: "[192.168.1.0/24]"
```

### 3.4. Update Signatures

```bash
sudo suricata-update
```

> Rules Ä‘Æ°á»£c lÆ°u táº¡i `/var/lib/suricata/rules`
{: .prompt-info }

### 3.5. Khá»Ÿi Ä‘á»™ng

```bash
sudo systemctl restart suricata
```

### 3.6. TÃ­ch há»£p vá»›i Wazuh

ThÃªm vÃ o `/var/ossec/etc/ossec.conf`:

```xml
<localfile>
  <log_format>json</log_format>
  <location>/var/log/suricata/eve.json</location>
</localfile>
```

### 3.7. Test SSH Detection

![SSH Detection](../assets/img/posts/soc-lab/ssh.png)
_Suricata phÃ¡t hiá»‡n SSH connection qua Wazuh_


## 4.  ThÃªm agent Windows
Dá»± Ä‘á»‹nh cá»§a mÃ¬nh lÃ  há»c thÃªm vá» cÃ¡ch viáº¿t signature cho 1 malware. Khi malware Ä‘áº¥y xuáº¥t hiá»‡n trÃªn Windows thÃ¬ wazuh cáº£nh bÃ¡o. (Note: váº«n chÆ°a cÃ³ viáº¿t signature)

Sau khi lÃ m theo cÃ¡c bÆ°á»›c cÃ i Ä‘áº·t agent, Ta chá»‰nh sá»­a file config trÃªn windows C:\Program Files (x86)\ossec-agent\ossec.conf

```
<server>
  <address>192.168.1.23</address>
  <port>1514</port>
</server>
```
Sau Ä‘Ã³ cháº¡y file auth_wazuh.exe vá»›i ip lÃ  mÃ¡y cá»§a wazuh server, cá»•ng tÆ°Æ¡ng tá»± trong file ossec.conf

![alt text](../assets/img/posts/soc-lab/image.png)
Ta Ä‘Ã£ thÃªm thÃ nh cÃ´ng

<!-- ![alt text](image-1.png) -->
Tiáº¿p Ä‘áº¿n ta tiáº¿n hÃ nh cÃ i sysmon cho windows vÃ  wazuh sáº½ theo dÃµi log do sysmon táº¡o ra.

Sá»­ dá»¥ng báº£n config ná»•i tiáº¿ng cho sysmon lÃ  https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml
. Cuá»‘i cÃ¹ng ta cháº¡y
```
Sysmon.exe -accepteula -i sysmonconfig-export.xml
```
![alt text](../assets/img/posts/soc-lab/image-3.png)
Äá»ƒ wazuh agent Ä‘á»c Ä‘Æ°á»£c log cá»§a sysmon, ta cáº§n cáº¥u hÃ¬nh file ossec.conf
```
<localfile>
<location>Microsoft-Windows-Sysmon/Operational</location>
<log_format>eventchannel</log_format>
</localfile>
```
Tiáº¿n hÃ nh tháº£ 1 malware vÃ o windows
![alt text](../assets/img/posts/soc-lab/image-2.png)
Ta Ä‘Ã£ tháº¥y Wazuh Ä‘Ã£ báº¯t Ä‘Æ°á»£c event thÃ nh cÃ´ng
---

## Káº¿t luáº­n

BÃ i lab Ä‘Ã£ hoÃ n thÃ nh viá»‡c:
- âœ… XÃ¢y dá»±ng web server vá»›i Cloudflare Tunnel
- âœ… Triá»ƒn khai Wazuh SIEM vá»›i Docker
- âœ… CÃ i Ä‘áº·t Suricata IDS
- âœ… TÃ­ch há»£p Suricata vá»›i Wazuh
- âœ… TÃ­ch há»£p Sysmon vá»›i Wazuh
- ğŸ”„ Shuffle SOAR (coming soon)



## Nguá»“n tham kháº£o

- [Wazuh Documentation](https://documentation.wazuh.com/)
- [Suricata User Guide](https://docs.suricata.io/)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Building a soc Lab at Home (PART 1)](https://medium.com/@linusobura/building-a-soc-lab-at-home-part-1-a638dec56f26)
- [
Integrating Suricata With Wazuh For Log Processing](https://www.youtube.com/watch?v=NB_u9m-MMcY)
- [Using Wazuh to monitor Sysmon events](https://wazuh.com/blog/using-wazuh-to-monitor-sysmon-events/)
---
