---
title: "BlueSky Lab - Network Intrusion & Ransomware Analysis"
date: 2025-07-04 12:00:00 +0700
categories: [CTF, Network Forensics]
tags: [wireshark, event-viewer, sql-injection, metasploit, ransomware, lateral-movement, credential-dumping]
image:
  path: /assets/img/posts/BlueSky-lab/banner.png
  alt: BlueSky Lab
---

## Gi·ªõi thi·ªáu

**Difficulty**: Medium  
**Category**: Network  
**Tools**: Event Viewer, Wireshark

B√†i lab ph√¢n t√≠ch network traffic v√† Windows Event logs ƒë·ªÉ ƒëi·ªÅu tra t·∫•n c√¥ng qua SQL Server, lateral movement v√† ransomware deployment.

## Q1: Knowing the source IP of the attack allows security teams to respond to potential threats quickly. Can you identify the source IP responsible for potential port scanning activity?

Ph√¢n t√≠ch Statistic, ta th·∫•y 2 ip g·ª≠i ch√≠nh

![image.png](/assets/img/posts/BlueSky-lab/image.png)

ta th·∫•y ip 87.***.84 g·ª≠i r·∫•t nhi·ªÅu g√≥i SYN l√† g√≥i kh·ªüi t·∫°o v·ªõi port kh√°c nhau ‚Üí ip c·ªßa attacker

## Q2: During the investigation, it's essential to determine the account targeted by the attacker. Can you identify the targeted account username?

![image.png](/assets/img/posts/BlueSky-lab/image%201.png)

ph√¢n t√≠ch protocol hierarchy, ta th·∫•y c√≥ giao th·ª©c TDS

TDS, a proprietary protocol by Microsoft, is primarily used for client-server communication with SQL Server

It facilitates operations such as login authentication, query execution, and data exchange

![image.png](/assets/img/posts/BlueSky-lab/image%202.png)

![image.png](/assets/img/posts/BlueSky-lab/image%203.png)

## Q3: We need to determine if the attacker succeeded in gaining access. Can you provide the correct password discovered by the attacker?

nh∆∞ tr√™n

## Q4: Attackers often change some settings to facilitate lateral movement within a network. What setting did the attacker enable to control the target host further and execute further commands?

![image.png](/assets/img/posts/BlueSky-lab/image%204.png)

sau khi login, SQL BATCH ƒë·∫ßu ti√™n ch·ª©a `configure`

The first command, `EXEC sp_configure 'show advanced options', 1; RECONFIGURE;`, enables the display and modification of advanced server options. By default, these options are hidden to prevent unauthorized or accidental changes, so enabling them is often the first step in escalating privileges or enabling dangerous functionalities.

The second command, `EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;`, is particularly noteworthy. This command enables the `xp_cmdshell` stored procedure, which allows SQL Server to execute operating system commands directly from the database.

![image.png](/assets/img/posts/BlueSky-lab/image%205.png)

Event ID `15457` is a security audit event generated by Microsoft SQL Server when the `xp_cmdshell` configuration setting is modified.

## Q5: Process injection is often used by attackers to escalate privileges within a system. What process did the attacker inject the C2 into to gain administrative privileges?

![image.png](/assets/img/posts/BlueSky-lab/image%206.png)

HostName l√† MFSConsole

- **Event ID 400** l√† log ƒë∆∞·ª£c ghi l·∫°i khi **PowerShell engine b·∫Øt ƒë·∫ßu kh·ªüi ch·∫°y**.
- N√≥ cho bi·∫øt PowerShell ƒë√£ s·∫µn s√†ng th·ª±c thi l·ªánh ho·∫∑c script.
- **Transition from 'None' to 'Available'**: Engine PowerShell ƒë√£ s·∫µn s√†ng ch·∫°y script.
- **Host name: MSFConsole**: ƒê√¢y l√† CLI ch√≠nh c·ªßa **Metasploit Framework** ‚Äì c√¥ng c·ª• t·∫•n c√¥ng m·∫°nh.
- **Host application: winlogon.exe**: PowerShell ƒë∆∞·ª£c ch·∫°y t·ª´ trong **winlogon.exe**.
ƒê√¢y l√† ƒëi·ªÉm b·∫•t th∆∞·ªùng ‚Üí **PowerShell kh√¥ng n√™n ƒë∆∞·ª£c g·ªçi t·ª´ winlogon.exe**!
- K·∫ª t·∫•n c√¥ng ƒë√£ d√πng **MSFConsole (Metasploit)** ƒë·ªÉ tri·ªÉn khai **payload d·∫°ng PowerShell**.
- Sau ƒë√≥, payload ƒë∆∞·ª£c **inject (ti√™m)** v√†o process h·ªá th·ªëng **winlogon.exe**.

‚û°Ô∏è **winlogon.exe** l√† m·ªôt process h·ªá th·ªëng r·∫•t quan tr·ªçng, ch·∫°y v·ªõi quy·ªÅn **SYSTEM (quy·ªÅn cao nh·∫•t)**.

‚úÖ N·∫øu k·∫ª t·∫•n c√¥ng ch√®n ƒë∆∞·ª£c m√£ v√†o winlogon.exe, h·ªç c√≥ th·ªÉ:

- Th·ª±c thi l·ªánh v·ªõi quy·ªÅn admin
- Tr·ªën tr√°nh detection
- Duy tr√¨ truy c·∫≠p l√¢u d√†i (persistence)

## Q6: Following privilege escalation, the attacker attempted to download a file. Can you identify the URL of this file downloaded?

![image.png](/assets/img/posts/BlueSky-lab/image%207.png)

file ƒë·∫ßu ti√™n l√† checking.ps1

![image.png](/assets/img/posts/BlueSky-lab/image%208.png)

server l√† SimpleHTTP ‚Üí a lightweight web server often deployed for quick file hosting during attacks.

![image.png](/assets/img/posts/BlueSky-lab/image%209.png)

### üîç **Gi·∫£i th√≠ch:**

- D√≤ng l·ªánh n√†y **v√¥ hi·ªáu h√≥a ki·ªÉm tra ch·ª©ng ch·ªâ s·ªë (SSL/TLS)** khi script k·∫øt n·ªëi ƒë·∫øn website qua HTTPS.
- **B√¨nh th∆∞·ªùng**, khi d√πng HTTPS, PowerShell s·∫Ω ki·ªÉm tra:
    - Ch·ª©ng ch·ªâ c√≥ h·ª£p l·ªá kh√¥ng?
    - C√≥ b·ªã gi·∫£ m·∫°o (self-signed) kh√¥ng?
    - C√≥ h·∫øt h·∫°n kh√¥ng?
- N·∫øu ch·ª©ng ch·ªâ c√≥ v·∫•n ƒë·ªÅ, PowerShell s·∫Ω t·ª´ ch·ªëi k·∫øt n·ªëi.

### ‚ùó **T·∫°i sao ƒë√°ng nghi:**

- K·∫ª t·∫•n c√¥ng **th∆∞·ªùng d√πng ch·ª©ng ch·ªâ t·ª± k√Ω (self-signed)** ho·∫∑c kh√¥ng h·ª£p l·ªá ‚Üí tr√°nh b·ªã ph√°t hi·ªán khi d·ª±ng server C2.
- ƒêo·∫°n n√†y **b·ªè qua to√†n b·ªô c·∫£nh b√°o**, **√©p m√°y n·∫°n nh√¢n lu√¥n tin t∆∞·ªüng server**, k·ªÉ c·∫£ ƒë·ªôc h·∫°i.

b√™n c·∫°nh ƒë√≥ c√≤n c√≥ d√≤ng

```bash
$WarningPreference = "SilentlyContinue"
$ErrorActionPreference = "SilentlyContinue"
```

- ƒê√¢y l√† c√°ch PowerShell ki·ªÉm so√°t l·ªói v√† c·∫£nh b√°o:
    - `WarningPreference`: ki·ªÉm so√°t th√¥ng b√°o **c·∫£nh b√°o (warning)**.
    - `ErrorActionPreference`: ki·ªÉm so√°t **l·ªói (error)**.
- `SilentlyContinue` = **khi g·∫∑p l·ªói/c·∫£nh b√°o th√¨ c·ª© ti·∫øp t·ª•c**, **kh√¥ng in g√¨ ra m√†n h√¨nh**.

### ‚ùó **T·∫°i sao ƒë√°ng nghi:**

- M·ªôt script h·ª£p l·ªá, minh b·∫°ch **s·∫Ω c·∫ßn th√¥ng b√°o l·ªói ƒë·ªÉ debug**.
- **K·∫ª t·∫•n c√¥ng** kh√¥ng mu·ªën ng∆∞·ªùi d√πng/ng∆∞·ªùi gi√°m s√°t **ph√°t hi·ªán ƒëi·ªÅu b·∫•t th∆∞·ªùng**, n√™n t·∫Øt h·∫øt c·∫£nh b√°o.
- ƒêi·ªÅu n√†y khi·∫øn:
    - C·∫£ ng∆∞·ªùi d√πng l·∫´n h·ªá th·ªëng gi√°m s√°t **kh√≥ ph√°t hi·ªán** script c√≥ l·ªói hay ƒëang ch·∫°y g√¨ m·ªù √°m

## Q7: Understanding which group Security Identifier (SID) the malicious script checks to verify the current user's privileges can provide insights into the attacker's intentions. Can you provide the specific Group SID that is being checked?

![image.png](/assets/img/posts/BlueSky-lab/image%2010.png)

This SID corresponds to the Administrators group, which grants elevated privileges on the local system.

If the user is a member of the Administrators group, the `$priv` variable is set to True, enabling the script to execute privileged actions without additional authentication.

## Q8: Windows Defender plays a critical role in defending against cyber threats. If an attacker disables it, the system becomes more vulnerable to further attacks. What are the registry keys used by the attacker to disable Windows Defender functionalities? Provide them in the same order found.

![image.png](/assets/img/posts/BlueSky-lab/image%2011.png)

## Q9: Can you determine the URL of the second file downloaded by the attacker?

![image.png](/assets/img/posts/BlueSky-lab/image%2012.png)

## Q10: Identifying malicious tasks and understanding how they were used for persistence helps in fortifying defenses against future attacks. What's the full name of the task created by the attacker to maintain persistence?

![image.png](/assets/img/posts/BlueSky-lab/image%2013.png)

Ti·∫øp t·ª•c follow theo http stream, t√¨m ki·∫øm t·ª´ task

## Q11: According to your analysis of the second malicious file, what is the MITRE ID of the tactic the file aims to achieve?

export del.ps1 v·ªÅ

```bash
Get-WmiObject _FilterToConsumerBinding -Namespace root\subscription | Remove-WmiObject

$list = "taskmgr", "perfmon", "SystemExplorer", "taskman", "ProcessHacker", "procexp64", "procexp", "Procmon", "Daphne"
foreach($task in $list)
{
    try {
        stop-process -name $task -Force
    }
    catch {}
}

stop-process $pid -Force
```

tra gpt, ta th·∫•y ƒë∆∞·ª£c ƒë√¢y l√† tactic defend evasion ‚Üí TA0005

## Q12: What's the invoked PowerShell script used by the attacker for dumping credentials?

![image.png](/assets/img/posts/BlueSky-lab/image%2014.png)

t·ª´ ki·∫øm c√°c http ti·∫øp theo v·ªõi t·ª´ kh√≥a dump

ho·∫∑c filter `http contains "lsass"`

![image.png](/assets/img/posts/BlueSky-lab/image%2015.png)

LSASS is a critical process in Windows that handles security policies, authentication, and the storage of credentials in memory.

## Q13: Understanding which credentials have been compromised is essential for assessing the extent of the data breach. What's the name of the saved text file containing the dumped credentials?

![image.png](/assets/img/posts/BlueSky-lab/image%2016.png)

gi·∫£i m√£ v√† ra ƒë∆∞·ª£c hashes.txt

![image.png](/assets/img/posts/BlueSky-lab/image%2017.png)

## Q14: Knowing the hosts targeted during the attacker's reconnaissance phase, the security team can prioritize their remediation efforts on these specific hosts. What's the name of the text file containing the discovered hosts?

![image.png](/assets/img/posts/BlueSky-lab/image%2018.png)

attacker ƒë√£ t√¨m ƒë∆∞·ª£c c√°c host, v√† m√°y n·∫°n nh√¢n GET v·ªÅ

## Q15: After hash dumping, the attacker attempted to deploy ransomware on the compromised host, spreading it to the rest of the network through previous lateral movement activities using SMB. You're provided with the ransomware sample for further analysis. By performing behavioral analysis, what's the name of the ransom note file?

- **SMB (Server Message Block)** l√† giao th·ª©c m·∫°ng cho ph√©p chia s·∫ª:
    - üìÇ File
    - üñ®Ô∏è M√°y in
    - üìÅ Th∆∞ m·ª•c
    - üìã Pipes (ƒë·ªÉ th·ª±c hi·ªán l·ªánh t·ª´ xa, v√≠ d·ª• nh∆∞ `IPC$`)
- R·∫•t ph·ªï bi·∫øn trong **h·ªá th·ªëng Windows n·ªôi b·ªô** v√† d√πng cho **qu·∫£n tr·ªã t·ª´ xa** (v√≠ d·ª• d√πng `psexec`, `net use`, ho·∫∑c PowerShell).
- **SMB c√≥ quy·ªÅn cao** (qu·∫£n tr·ªã vi√™n th∆∞·ªùng d√πng ƒë·ªÉ ƒëi·ªÅu khi·ªÉn m√°y kh√°c).
- N·∫øu **misconfigured** (v√≠ d·ª• chia s·∫ª c√¥ng khai, ho·∫∑c kh√¥ng x√°c th·ª±c t·ªët), attacker c√≥ th·ªÉ:
    - **Di chuy·ªÉn ngang** trong m·∫°ng.
    - **L·∫•y tr·ªôm hash**, ho·∫∑c **replay token** (Pass-the-Hash).
    - **Th·ª±c thi l·ªánh t·ª´ xa** (Remote Code Execution).

![image.png](/assets/img/posts/BlueSky-lab/image%2019.png)

m√£ hash c·ªßa javar.exe

![image.png](/assets/img/posts/BlueSky-lab/image%2020.png)

## Q16: In some cases, decryption tools are available for specific ransomware families. Identifying the family name can lead to a potential decryption solution. What's the name of this ransomware family?

tra virustotal
