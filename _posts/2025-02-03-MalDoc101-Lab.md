---
title: "MalDoc101 Lab - Malicious Office Document Analysis"
date: 2025-07-04 12:00:00 +0700
categories: [CTF, Malware Analysis]
tags: [ole, vba, macros, maldoc, office, base64]
image:
  path: /assets/img/posts/MalDoc101-Lab/banner.png
  alt: MalDoc101 Lab
---
## Gi·ªõi thi·ªáu

**Difficulty**: Medium  
**Category**: Malware  
**Tools**: Ole, VirusTotal, oledump

B√†i lab ph√¢n t√≠ch t√†i li·ªáu Microsoft Office ch·ª©a macro ƒë·ªôc h·∫°i.

## Q1: Multiple streams contain macros in this document. Provide the number of the highest one.

```python
‚îå‚îÄ‚îÄ(nqghuy„âøDESKTOP-AJTP5JK)-[/mnt/e/CTF/forensics/51-maldoc101/temp_extract_dir/MalDoc101]
‚îî‚îÄ$ file sample.bin
sample.bin: Composite Document File V2 Document, Little Endian, Os: Windows, Version 10.0, Code page: 1252, Template: Normal.dotm, Revision Number: 1, Name of Creating Application: Microsoft Office Word, Create Time/Date: Wed Jul 22 23:12:00 2020, Last Saved Time/Date: Wed Jul 22 23:12:00 2020, Number of Pages: 1, Number of Words: 3, Number of Characters: 21, Security: 0
```

`sample.bin` l√† m·ªôt **t√†i li·ªáu Microsoft Word d·∫°ng c≈© (OLE format)** ‚Äî ch√≠nh l√† d·∫°ng ch·ª©a c√°c **stream n·ªôi b·ªô**, nh∆∞ ta n√≥i ·ªü tr√™n.

### "Streams" l√† g√¨?

- Trong c√°c t√†i li·ªáu ki·ªÉu c≈© c·ªßa Microsoft (nh∆∞ `.doc`, `.xls` ‚Äì c√≤n g·ªçi l√† OLE/Compound File Binary Format), n·ªôi dung b√™n trong ƒë∆∞·ª£c t·ªï ch·ª©c nh∆∞ **m·ªôt h·ªá th·ªëng t·ªáp b√™n trong m·ªôt t·ªáp**.
- M·ªói ph·∫ßn b√™n trong ƒë∆∞·ª£c g·ªçi l√† m·ªôt **stream** ‚Äì gi·ªëng nh∆∞ l√† m·ªôt file con.
- V√≠ d·ª•: t√†i li·ªáu c√≥ th·ªÉ c√≥ c√°c stream nh∆∞ `WordDocument`, `Macros/VBA/Module1`, `Macros/VBA/ThisDocument`, ...

üí° T∆∞·ªüng t∆∞·ª£ng: file `.doc` gi·ªëng nh∆∞ m·ªôt c√°i **USB nh·ªè**, b√™n trong ch·ª©a nhi·ªÅu **file con (streams)**.

### "Macros" l√† g√¨?

- **Macro** l√† c√°c ƒëo·∫°n m√£ ƒë∆∞·ª£c vi·∫øt b·∫±ng **VBA (Visual Basic for Applications)**, ƒë∆∞·ª£c d√πng trong Microsoft Office ƒë·ªÉ t·ª± ƒë·ªông h√≥a m·ªôt s·ªë t√°c v·ª• (nh∆∞ in, x·ª≠ l√Ω d·ªØ li·ªáu, n√∫t b·∫•m...).
- Tuy nhi√™n, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ **ch√®n m√£ ƒë·ªôc v√†o macro**, v√≠ d·ª•: t·∫£i v·ªÅ file ƒë·ªôc h·∫°i, th·ª±c thi PowerShell, ƒë√°nh c·∫Øp d·ªØ li·ªáu,...

üëâ V√¨ th·∫ø, khi ph√¢n t√≠ch file nghi l√† malware, ng∆∞·ªùi ta s·∫Ω ki·ªÉm tra xem **c√≥ macro kh√¥ng**, macro n·∫±m ·ªü stream n√†o, v√† s·ªë l∆∞·ª£ng bao nhi√™u.

Tr∆∞·ªõc h·∫øt, t·∫£i 1 s·ªë tool

```python
pip install oletools
git clone https://github.com/DidierStevens/DidierStevensSuite.git
```

```python
‚îå‚îÄ‚îÄ(nqghuy„âøDESKTOP-AJTP5JK)-[/mnt/e/CTF/forensics/51-maldoc101/temp_extract_dir/MalDoc101]
‚îî‚îÄ$ python3 DidierStevensSuite/oledump.py sample.bin
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      7119 '1Table'
  5:    101483 'Data'
  6:       581 'Macros/PROJECT'
  7:       119 'Macros/PROJECTwm'
  8:     12997 'Macros/VBA/_VBA_PROJECT'
  9:      2112 'Macros/VBA/__SRP_0'
 10:       190 'Macros/VBA/__SRP_1'
 11:       532 'Macros/VBA/__SRP_2'
 12:       156 'Macros/VBA/__SRP_3'
 13: M    1367 'Macros/VBA/diakzouxchouz'
 14:       908 'Macros/VBA/dir'
 15: M    5705 'Macros/VBA/govwiahtoozfaid'
 16: m    1187 'Macros/VBA/roubhaol'
 17:        97 'Macros/roubhaol/\x01CompObj'
 18:       292 'Macros/roubhaol/\x03VBFrame'
 19:       510 'Macros/roubhaol/f'
 20:       112 'Macros/roubhaol/i05/\x01CompObj'
 21:        44 'Macros/roubhaol/i05/f'
 22:         0 'Macros/roubhaol/i05/o'
 23:       112 'Macros/roubhaol/i07/\x01CompObj'
 24:        44 'Macros/roubhaol/i07/f'
 25:         0 'Macros/roubhaol/i07/o'
 26:       115 'Macros/roubhaol/i09/\x01CompObj'
 27:       176 'Macros/roubhaol/i09/f'
 28:       110 'Macros/roubhaol/i09/i11/\x01CompObj'
 29:        40 'Macros/roubhaol/i09/i11/f'
 30:         0 'Macros/roubhaol/i09/i11/o'
 31:       110 'Macros/roubhaol/i09/i12/\x01CompObj'
 32:        40 'Macros/roubhaol/i09/i12/f'
 33:         0 'Macros/roubhaol/i09/i12/o'
 34:     15164 'Macros/roubhaol/i09/o'
 35:        48 'Macros/roubhaol/i09/x'
 36:       444 'Macros/roubhaol/o'
 37:      4096 'WordDocument'
```

- **M (Uppercase M):** ch·ª©a attributes v√† compressed VBA code, th∆∞·ªùng l√† m√£ ƒë·ªçc
- **m (Lowercase m):** th∆∞·ªùng ch·ªâ ch·ª©a attributes

`Attributes`  metadata ho·∫∑c descriptive information li√™n quan ƒë·∫øn VBA macro. 

## Q2: What event is used to begin the execution of the macros?

![image.png](/assets/img/posts/MalDoc101-Lab/image.png)

ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† khi Doc ƒë∆∞·ª£c m·ªü th√¨ macro t·ª± ƒë·ªông th·ª±c thi

## Q3: What malware family was this maldoc attempting to drop?

D√πng sha256sum v√† tra tr√™n VirusTotal

## Q4: What stream is responsible for the storage of the base64-encoded string?

V·∫´n d√πng olevba

![image.png](/assets/img/posts/MalDoc101-Lab/image%201.png)

![image.png](/assets/img/posts/MalDoc101-Lab/image%202.png)

## Q5: This document contains a user-form. Provide the name.
Theo Internet ho·∫∑c gpt
In the context of Microsoft Office documents, a `user-form` is a graphical interface embedded within a VBA macro. It provides a way to interact with users, gather input, or execute certain functions. Malicious actors often use user-forms to execute hidden code, deceive users, or facilitate the delivery of malicious payloads.

![Event-combos.png](/assets/img/posts/MalDoc101-Lab/Event-combos.png)

![10-1.webp](/assets/img/posts/MalDoc101-Lab/10-1.webp)

1 s·ªë userform

These `.frm` files define the layout and functionality of the user-form, including any properties or event handlers associated with it.

The `.frm` extension confirms that this stream stores a form definition, which is part of the VBA project embedded in the document. 

![image.png](/assets/img/posts/MalDoc101-Lab/image%203.png)

## Q6: This document contains an obfuscated Base64 encoded string; what value is used to pad (or obfuscate) this string?

![image.png](/assets/img/posts/MalDoc101-Lab/image%204.png)

![image.png](/assets/img/posts/MalDoc101-Lab/image%205.png)

![image.png](/assets/img/posts/MalDoc101-Lab/image%206.png)

trong code c√≥ ƒëo·∫°n split `2342772g3&*gs7712ffvs626fq` ‚Üí ƒë√¢y l√† chu·ªói padding

## Q7: What is the program executed by the Base64 encoded string?

sau khi x√≥a h·∫øt chu·ªói tr√™n 

```python
powersheLL -e JABsAGkAZ.....QB2AGMAYQBvAGoAJwA=
```

## Q8: What WMI class is used to create the process to launch the Trojan?

![image.png](/assets/img/posts/MalDoc101-Lab/image%207.png)

WMI is a powerful framework within Windows that provides administrative tools and allows scripts or applications to perform operations on local or remote systems. Attackers frequently exploit WMI to execute commands, manage processes, and evade detection by integrating malicious payloads into legitimate system operations.

## Q9: Multiple domains were contacted to download a trojan. Provide first FQDN as per the provided hint.

t·ª´ ·∫£nh tr√™n ‚Üí http://haoqunkong.com/

